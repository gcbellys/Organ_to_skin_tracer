# Organ-to-Skin Tracer

ä¸€ä¸ªä¸“ä¸šçš„å™¨å®˜åˆ°çš®è‚¤å°„çº¿è¿½è¸ªé¡¹ç›®ï¼Œç”¨äºè®¡ç®—ä»å™¨å®˜ç‰¹å¾ç‚¹åˆ°çš®è‚¤è¡¨é¢çš„å°„çº¿äº¤ç‚¹ã€‚

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäºäººä½“è§£å‰–å­¦çš„çƒé¢åæ ‡ç³»å°„çº¿è¿½è¸ªç®—æ³•ï¼Œä¸»è¦ç”¨äºåŒ»å­¦å½±åƒåˆ†æä¸­çš„å™¨å®˜-çš®è‚¤å°„çº¿è¿½è¸ªç ”ç©¶ã€‚é€šè¿‡å®šä¹‰å€¾æ–œè§’(Î±)å’Œæ–¹ä½è§’(Î¸)ä¸¤ä¸ªå‚æ•°ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶å°„çº¿çš„å…¥å°„æ–¹å‘ï¼Œå®ç°ç³»ç»Ÿæ€§çš„å°„çº¿è¿½è¸ªåˆ†æã€‚

## ğŸ“ é¡¹ç›®ç»“æ„

```
Organ-to-Skin-Tracer/
â”œâ”€â”€ ğŸ“ data/                    # è¾“å…¥æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ skin.obj               # çš®è‚¤æ¨¡å‹æ–‡ä»¶
â”‚   â”œâ”€â”€ thyroid.obj            # ç”²çŠ¶è…ºæ¨¡å‹æ–‡ä»¶
â”‚   â””â”€â”€ skin.mtl               # æè´¨æ–‡ä»¶
â”œâ”€â”€ ğŸ“ src/                    # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ main.py                # ä¸»ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ ray_tracing.py         # å°„çº¿è¿½è¸ªæ ¸å¿ƒç®—æ³•
â”‚   â”œâ”€â”€ geometry_utils.py      # å‡ ä½•è®¡ç®—å·¥å…·
â”‚   â”œâ”€â”€ data_loader.py         # æ•°æ®åŠ è½½æ¨¡å—
â”‚   â”œâ”€â”€ io_utils.py            # æ–‡ä»¶IOå·¥å…·
â”‚   â””â”€â”€ extract_key_points.py  # ç‰¹å¾ç‚¹æå–
â”œâ”€â”€ ğŸ“ data_process/           # æ•°æ®é¢„å¤„ç†æ¨¡å—
â”‚   â”œâ”€â”€ process_all_data.py    # ä¸€é”®æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ preprocess_obj_with_params.py  # çš®è‚¤æ¨¡å‹é¢„å¤„ç†
â”‚   â””â”€â”€ apply_transform_to_thyroid.py  # ç”²çŠ¶è…ºç‚¹äº‘å¯¹é½
â”œâ”€â”€ ğŸ“ output/                 # è¾“å‡ºç»“æœç›®å½•
â”‚   â”œâ”€â”€ preprocessed/          # é¢„å¤„ç†ç»“æœ
â”‚   â””â”€â”€ results/               # å®éªŒç»“æœ
â”œâ”€â”€ run_complete_workflow.py   # ä¸€é”®å¼å®Œæ•´å·¥ä½œæµç¨‹
â”œâ”€â”€ requirements.txt           # Pythonä¾èµ–
â”œâ”€â”€ environment.yml            # Condaç¯å¢ƒé…ç½®
â”œâ”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
â””â”€â”€ GUIDE.md                   # åæ ‡ç³»è¯¦ç»†æŒ‡å—
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè®¾ç½®

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨Condaï¼ˆæ¨èï¼‰
```bash
# è‡ªåŠ¨è®¾ç½®ç¯å¢ƒ
conda env create -f environment.yml
conda activate organ-skin-tracer
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨pip
```bash
pip install -r requirements.txt
```

### ä¸€é”®è¿è¡Œå®Œæ•´æµç¨‹
```bash
python run_complete_workflow.py
```

è¿™å°†è‡ªåŠ¨æ‰§è¡Œï¼š
1. æ•°æ®é¢„å¤„ç†å’Œå¯¹é½
2. ç”²çŠ¶è…ºç‰¹å¾ç‚¹æå–
3. å°„çº¿è¿½è¸ªå®éªŒ
4. ç»“æœä¿å­˜å’Œå±•ç¤º

## ğŸ“– è¯¦ç»†ä½¿ç”¨æ–¹æ³•

### 1. æ•°æ®å‡†å¤‡

å°†æ‚¨çš„æ¨¡å‹æ–‡ä»¶æ”¾ç½®åœ¨ `data/` ç›®å½•ä¸‹ï¼š
- `skin.obj` - çš®è‚¤æ¨¡å‹
- `thyroid.obj` - ç”²çŠ¶è…ºæ¨¡å‹

### 2. åˆ†æ­¥æ‰§è¡Œ

#### æ•°æ®å¤„ç†
```bash
cd data_process
python process_all_data.py
```

#### ç‰¹å¾ç‚¹æå–
```bash
cd src
python extract_key_points.py ../data/thyroid.obj ../output/preprocessed/thyroid_points.obj
```

#### å°„çº¿è¿½è¸ªå®éªŒ
```bash
# è¿è¡Œé»˜è®¤å‚æ•°å®éªŒ
python main.py

# æˆ–ä½¿ç”¨å°„çº¿è¿½è¸ªæ¨¡å—ï¼ˆæ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼‰
python ray_tracing.py ../output/preprocessed/thyroid_points.obj ../data/skin.obj 30 0 ../output/results
```

### 3. è‡ªå®šä¹‰å‚æ•°å®éªŒ

```bash
python src/ray_tracing.py <ç”²çŠ¶è…ºå…³é”®ç‚¹æ–‡ä»¶> <çš®è‚¤æ¨¡å‹æ–‡ä»¶> <å€¾æ–œè§’> <æ–¹ä½è§’> <è¾“å‡ºç›®å½•>
```

ç¤ºä¾‹ï¼š
```bash
# ä»å‰æ–¹30åº¦å€¾æ–œè§’ï¼Œ0åº¦æ–¹ä½è§’è¿›è¡Œå°„çº¿è¿½è¸ª
python src/ray_tracing.py output/preprocessed/thyroid_points.obj data/skin.obj 30 0 output/results

# ä»å·¦ä¾§45åº¦å€¾æ–œè§’ï¼Œ90åº¦æ–¹ä½è§’è¿›è¡Œå°„çº¿è¿½è¸ª
python src/ray_tracing.py output/preprocessed/thyroid_points.obj data/skin.obj 45 90 output/results
```

## ğŸ§® åæ ‡ç³»è¯´æ˜

é¡¹ç›®ä½¿ç”¨åŸºäºäººä½“è§£å‰–å­¦çš„çƒé¢åæ ‡ç³»æ¥å®šä¹‰å°„çº¿æ–¹å‘ï¼š

### è§’åº¦å‚æ•°
- **å€¾æ–œè§’ Î± (alpha)**ï¼š0Â°-180Â°
  - 0Â°ï¼šä»æ­£å‰æ–¹å‚ç›´å…¥å°„
  - 45Â°ï¼šä»å‰æ–¹åç¦»45åº¦
  - 90Â°ï¼šä¸æ­£å‰æ–¹å‚ç›´ï¼ˆå¦‚ä»ä¸Šæ–¹ã€å·¦æ–¹ç­‰ï¼‰
- **æ–¹ä½è§’ Î¸ (theta)**ï¼š0Â°-360Â°
  - 0Â°ï¼šæœä¸Šæ–¹å€¾æ–œ
  - 90Â°ï¼šæœå·¦ä¾§å€¾æ–œ
  - 180Â°ï¼šæœä¸‹æ–¹å€¾æ–œ
  - 270Â°ï¼šæœå³ä¾§å€¾æ–œ

### å¸¸è§è§’åº¦ç»„åˆç¤ºä¾‹

| Î± (å€¾æ–œè§’) | Î¸ (æ–¹ä½è§’) | å°„çº¿æ–¹å‘æè¿° |
|-----------|-----------|-------------|
| 0Â°        | ä»»æ„      | ä»æ­£å‰æ–¹å‚ç›´å…¥å°„ |
| 45Â°       | 0Â°        | ä»å‰æ–¹åä¸Š45åº¦å…¥å°„ |
| 45Â°       | 90Â°       | ä»å‰æ–¹åå·¦45åº¦å…¥å°„ |
| 45Â°       | 180Â°      | ä»å‰æ–¹åä¸‹45åº¦å…¥å°„ |
| 45Â°       | 270Â°      | ä»å‰æ–¹åå³45åº¦å…¥å°„ |
| 90Â°       | 0Â°        | ä»æ­£ä¸Šæ–¹å‚ç›´å…¥å°„ |
| 90Â°       | 90Â°       | ä»æ­£å·¦æ–¹å‚ç›´å…¥å°„ |
| 90Â°       | 180Â°      | ä»æ­£ä¸‹æ–¹å‚ç›´å…¥å°„ |
| 90Â°       | 270Â°      | ä»æ­£å³æ–¹å‚ç›´å…¥å°„ |

è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ [GUIDE.md](GUIDE.md)ã€‚

## ğŸ“Š è¾“å‡ºæ ¼å¼

### å®éªŒç»“æœç›®å½•ç»“æ„
```
output/results/
â”œâ”€â”€ alpha_30_theta_0/          # æŒ‰è§’åº¦å‘½åçš„å®éªŒç›®å½•
â”‚   â”œâ”€â”€ intersection_points.ply # å°„çº¿äº¤ç‚¹åæ ‡ï¼ˆPLYæ ¼å¼ï¼‰
â”‚   â”œâ”€â”€ metadata.json          # å®éªŒå…ƒæ•°æ®
â”‚   â”œâ”€â”€ ray_trace_result.json  # è¯¦ç»†è¿½è¸ªç»“æœ
â”‚   â”œâ”€â”€ intersections.obj      # äº¤ç‚¹åæ ‡ï¼ˆOBJæ ¼å¼ï¼‰
â”‚   â””â”€â”€ ray_pairs.obj          # æºç‚¹-äº¤ç‚¹å¯¹
â””â”€â”€ alpha_45_theta_90/
    â””â”€â”€ ...
```

### å…ƒæ•°æ®æ ¼å¼
```json
{
    "timestamp": "2024-01-01T12:00:00",
    "parameters": {
        "alpha_deg": 30.0,
        "theta_deg": 0.0
    },
    "input_files": {
        "skin": "skin.obj",
        "thyroid_points_source": "thyroid.obj"
    },
    "results_summary": {
        "total_source_points": 7,
        "rays_that_hit": 5
    },
    "source_to_intersection_map": [
        {
            "source_coord": [x1, y1, z1],
            "intersection_coord": [x2, y2, z2]
        }
    ]
}
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è¯´æ˜

### config.py
- é›†ä¸­ç®¡ç†æ‰€æœ‰è·¯å¾„å’Œé»˜è®¤å‚æ•°
- ä½¿ç”¨ pathlib æä¾›è·¨å¹³å°è·¯å¾„æ“ä½œ

### geometry_utils.py
- `get_direction_from_angles()`ï¼šè§’åº¦åˆ°æ–¹å‘å‘é‡è½¬æ¢
- `transform_scene()`ï¼šåœºæ™¯åæ ‡ç³»å˜æ¢
- `calculate_intersections()`ï¼šå°„çº¿è¿½è¸ªè®¡ç®—

### ray_tracing.py
- ç‹¬ç«‹çš„å°„çº¿è¿½è¸ªæ¨¡å—
- æ”¯æŒå‘½ä»¤è¡Œå‚æ•°
- è¯¦ç»†çš„äº¤ç‚¹å’Œè·ç¦»è®¡ç®—

### data_loader.py
- æ™ºèƒ½æ•°æ®åŠ è½½ï¼ˆä¼˜å…ˆä½¿ç”¨å¤„ç†åçš„æ¨¡å‹ï¼‰
- æ•°æ®å¥å…¨æ€§æ£€æŸ¥

### io_utils.py
- ä¿å­˜å®éªŒç»“æœä¸ºPLYæ ¼å¼
- ä¿å­˜å®éªŒå…ƒæ•°æ®ä¸ºJSONæ ¼å¼

## ğŸ¯ é¡¹ç›®ç‰¹è‰²

- **è§£å‰–å­¦å¯¼å‘**ï¼šåŸºäºäººä½“è§£å‰–å­¦çš„åæ ‡ç³»è®¾è®¡
- **æ¨¡å—åŒ–è®¾è®¡**ï¼šé«˜å†…èšä½è€¦åˆï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **å®éªŒå¯è¿½æº¯**ï¼šæ¯æ¬¡å®éªŒéƒ½æœ‰å®Œæ•´çš„å…ƒæ•°æ®è®°å½•
- **å‚æ•°åŒ–å®éªŒ**ï¼šæ”¯æŒæ‰¹é‡è¿è¡Œä¸åŒå‚æ•°ç»„åˆ
- **è·¨å¹³å°å…¼å®¹**ï¼šä½¿ç”¨ pathlib ç¡®ä¿è·¨å¹³å°å…¼å®¹æ€§
- **ä¸€é”®å¼æµç¨‹**ï¼šæä¾›å®Œæ•´çš„å·¥ä½œæµç¨‹è„šæœ¬

## ğŸ“‹ ä¾èµ–è¦æ±‚

- Python 3.7+
- trimesh
- numpy
- pyvista
- pathlib

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. æ‰“å¼€ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤ Issue
- å‘é€é‚®ä»¶

---

**æ³¨æ„**ï¼šæœ¬é¡¹ç›®ä¸»è¦ç”¨äºåŒ»å­¦å½±åƒåˆ†æç ”ç©¶ï¼Œè¯·ç¡®ä¿éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„å’Œä¼¦ç†è¦æ±‚ã€‚ 
# 指南：用于定义射线方向的球面坐标系

## 1. 目的

本指南详细描述了项目中用于定义射线方向的坐标系统。其核心目标是建立一个**以三维模型自身为中心、不受模型在世界坐标系中位置影响**的、规范化的角度定义方法。

通过该方法，我们可以使用一对角度参数 `(alpha, theta)`，精确地、无歧义地生成任何一个源自"人体正面"的入射方向，从而进行系统性的射线追踪分析。

## 2. 核心概念

我们的系统基于以下三个核心概念：

* **模型中心原点 (Model-Centric Origin)**: 我们不使用世界坐标系的 `(0,0,0)` 作为原点，而是动态计算当前皮肤模型的**包围盒中心**，并以此作为所有角度计算的逻辑原点。
* **解剖学参考系 (Anatomical Reference Frame)**: 我们定义了一个固定的、符合人体解剖学方向的参考系，它由三个互相垂直的基准向量（前、上、左）构成。
* **双角度定义 (Two-Angle Definition)**: 任意一个三维方向都可以由一个**倾斜角 (α)** 和一个**方位角 (θ)** 相对于上述参考系来唯一确定。

## 3. 分步实现流程

#### 步骤一：确定坐标系原点 (`C_origin`)

这是所有计算的中心参考点。我们通过代码动态获取皮肤模型的几何中心。

```python
import pyvista as pv
import numpy as np

# 加载皮肤模型
skin_mesh = pv.read("data/skin.obj")

# 使用 .center 属性获取模型包围盒的中心点
# 这个点就是我们球面坐标系的逻辑原点
C_origin = np.array(skin_mesh.center)

print(f"坐标系原点已确定为: {C_origin}")
```

#### 步骤二：定义基准参考系

为了描述角度，我们需要一个"罗盘"。这个罗盘由三个标准方向的向量构成，我们约定：

* **`D_base`**: 指向人体**后方**的向量，代表了从**正前方**入射的基准线。
* **`V_up`**: 指向人体**头顶**的向量。
* **`V_left`**: 指向人体**左侧**的向量。

```python
# 基准方向 (正前方 -> 正后方)
D_base = np.array([0, -1, 0])

# 上方参考方向 (脚 -> 头)
V_up = np.array([0, 0, 1])

# 左侧参考方向 (通过叉乘计算，确保与前两者垂直)
V_left = np.cross(D_base, V_up)

# 现在我们有了一个完整的、正交的参考系
print(f"基准方向 (Frontal): {D_base}")
print(f"上方参考 (Superior): {V_up}")
print(f"左侧参考 (Left):     {V_left}")
```

#### 步骤三：理解球面坐标参数 (α 和 θ)

我们使用两个角度来精确描述方向：

* **倾斜角 `alpha` (α)**:
  * 定义：最终射线方向与**基准方向 `D_base`** 之间的夹角。
  * 范围：`0°` 到 `180°`。
  * `α = 0°`：表示射线完全从正前方入射，没有倾斜。
  * `α = 45°`：表示射线从一个与正前方呈45度角的方向入射。
  * `α = 90°`：表示射线方向与正前方完全垂直（例如，从正上方或正左方入射）。

* **方位角 `theta` (θ)**:
  * 定义：描述倾斜的**方位**，即围绕 `D_base` 轴的旋转角度。
  * 范围：`0°` 到 `360°`。
  * `θ = 0°`：朝**上方** (`V_up`) 的方向倾斜。
  * `θ = 90°`：朝**左侧** (`V_left`) 的方向倾斜。
  * `θ = 180°`：朝**下方** (`-V_up`) 的方向倾斜。
  * `θ = 270°`：朝**右侧** (`-V_left`) 的方向倾斜。

#### 步骤四：将角度映射为三维方向向量

这是最核心的计算。以下函数接收 `alpha` 和 `theta`，并输出一个标准化的三维方向向量。这个函数已经实现在项目的 `src/geometry_utils.py` 模块中。

```python
# 位于 src/geometry_utils.py

import numpy as np

def get_direction_from_angles(alpha_deg, theta_deg):
    """
    根据给定的倾斜角(alpha)和方位角(theta)计算最终的入射方向向量。

    该函数基于一个标准的解剖学参考系：
    - 基准方向 (D_base): 从正前方射入 (0, -1, 0)
    - 上方 (V_up): 指向头顶 (0, 0, 1)

    参数:
    alpha_deg (float): 倾斜角(度)，与正前方基准方向的夹角。
    theta_deg (float): 方位角(度)，围绕基准方向的旋转角度。
                       0度代表朝上，90度代表朝左。

    返回:
    np.ndarray: 计算出的三维单位方向向量。
    """
    # 将角度从度转换为弧度，以便三角函数计算
    alpha_rad = np.deg2rad(alpha_deg)
    theta_rad = np.deg2rad(theta_deg)
    
    # 定义标准参考系
    D_base = np.array([0, -1, 0])
    V_up = np.array([0, 0, 1])
    V_left = np.cross(D_base, V_up)

    # 最终向量是三个基准向量的线性组合
    # 它的"向前"分量由 cos(alpha) 决定
    comp_base = np.cos(alpha_rad)
    
    # 它的"偏离"分量 (在垂直于D_base的平面上) 的总大小由 sin(alpha) 决定
    perp_magnitude = np.sin(alpha_rad)
    
    # 将偏离分量再次分解到"上下"和"左右"两个方向上
    comp_up = perp_magnitude * np.cos(theta_rad)
    comp_left = perp_magnitude * np.sin(theta_rad)
    
    # 通过加权求和，合成最终的方向向量
    final_direction = (D_base * comp_base) + \
                      (V_up * comp_up) + \
                      (V_left * comp_left)
    
    return final_direction
```

## 4. 使用示例

在主流程 (`main.py`) 中，您可以这样使用上述函数来执行一次逆向射线追踪：

```python
# 位于 src/main.py (示意)

# 1. 设定您想要测试的角度
test_alpha = 45.0  # 从前方偏离45度
test_theta = 90.0  # 朝向身体左侧

# 2. 计算入射方向向量
# 这是从体外射向体内的方向
incoming_direction = get_direction_from_angles(test_alpha, test_theta)

# 3. 确定逆向射线的方向
# 这是我们实际使用的，从器官射向皮肤的方向
ray_direction = -incoming_direction

print(f"为角度 (α={test_alpha}, θ={test_theta}) 计算出的逆射线方向为: {np.round(ray_direction, 3)}")

# 4. 使用该方向进行射线追踪
# ... (在主循环中调用)
# intersections = calculate_intersections(skin_mesh, organ_points, ray_direction)
# ...
```

## 5. 角度参数的实际意义

### 常见角度组合示例：

| α (倾斜角) | θ (方位角) | 射线方向描述 |
|-----------|-----------|-------------|
| 0°        | 任意      | 从正前方垂直入射 |
| 45°       | 0°        | 从前方偏上45度入射 |
| 45°       | 90°       | 从前方偏左45度入射 |
| 45°       | 180°      | 从前方偏下45度入射 |
| 45°       | 270°      | 从前方偏右45度入射 |
| 90°       | 0°        | 从正上方垂直入射 |
| 90°       | 90°       | 从正左方垂直入射 |
| 90°       | 180°      | 从正下方垂直入射 |
| 90°       | 270°      | 从正右方垂直入射 |

## 6. 坐标系优势

1. **解剖学直观性**: 角度定义符合人体解剖学习惯
2. **模型无关性**: 不受模型在世界坐标系中位置的影响
3. **参数连续性**: 角度变化对应平滑的方向变化
4. **计算稳定性**: 基于标准三角函数，数值稳定
5. **可扩展性**: 易于添加新的角度组合和参数扫描

通过遵循本指南，项目中的所有方向性计算都有了统一、规范且可复现的基准，为后续的科学分析和可视化奠定了坚实的基础。 